name: Tests

on:
  push:
    branches:
      - main
      - staging
  pull_request:
    branches:
      - main
      - staging

jobs:
  test: Run Tests
  runs-on: ubuntu-latest

  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      id: tests
      run: |
        echo "::notice::Running test suite..."
        npm test
      env:
        NODE_ENV: test
        NODE_OPTIONS: --experimental-vm-modules
        DATABASE_URL: ${{ secrets.TEST_DATABASE_URL || 'postgresql://test:test@localhost:5432/test_inventory' }}
        JWT_SECRET: test-secret-for-ci
        LOG_LEVVEL: error

    - name: Upload coverage Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: |
          coverage/
          test-results.xml
        retention-days: 30
        if-no-files-found: warn

    - name: Generate test summary
      if: always()
      run: |
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.tests.outcome }}" == "success" ]; then
          echo "All tests passed successfully." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Coverage Status" >> $GITHUB_STEP_SUMMARY
          echo "Coverage Reports have been uploaded as artifacts and retained 30 days." >> $GITHUB_STEP_SUMMARY
        else
          echo "Some tests failed. Please check the logs for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the failed tests." >> $GITHUB_STEP_SUMMARY
          echo "2. Fix the failing tests locally." >> $GITHUB_STEP_SUMMARY
          echo "3. Run \`npm run test\` locally to verify fixes" >> $GITHUB_STEP_SUMMARY
          echo "4. Commit and Push your changes." >> $GITHUB_STEP_SUMMARY
        fi

    - name: Annotate test failures
      if: failure()
      run: |
        echo "::error::Test suite failed - please check the test output for specific failure details."
        echo "::notice::Run 'npm run test' locally to reproduce and debug the failing tests."